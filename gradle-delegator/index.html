<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<title>Gradle, the Ultimate Delegator</title>


<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><link rel="stylesheet" href="/notes-vault/reveal-js/dist/reset.css">
<link rel="stylesheet" href="/notes-vault/reveal-js/dist/reveal.css"><link rel="stylesheet" href="/notes-vault/reveal-js/dist/theme/simple.css" id="theme">
<link rel="stylesheet" href="/notes-vault/highlight-js/idea.min.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
    .qr {
      padding: 20px;
      background-color: white;
      border: 2px solid #ccc;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .qr img {
        display: block;
        margin: 0 auto;
    }

    .qr-columns {
        display: flex;  
        justify-content: space-between;  
        gap: 20px;  
    }

    .qr-item {
        flex: 1;  
        text-align: center;  
    }

    .qr-item h3 {
        margin-bottom: 10px;  
    }

    .qr-item div {
        margin: 0 auto;  
        width: 200px;  
        height: 200px;  
    }
</style>

<style>
    .reveal pre {
        font-size: 0.45em;
    }
</style>
  </head>
  <body>
    
    <div class="reveal">
      <div class="slides">
  

    <section><h3 id="gradle-the-ultimate-delegator">Gradle: The Ultimate Delegator</h3>
<figure><img src="/notes-vault/gradle-delegator/images/alligator.jpeg" width="400" height="216">
</figure>

</section><section>


<section data-shortcode-section>
<h3 id="where-does-it-begin">Where Does It Begin?</h3>
<pre><code class="language-kotlin" data-line-numbers>plugins {
    id(&quot;org.jetbrains.kotlin.jvm&quot;)
}

java {
    sourceCompatibility = JavaVersion.VERSION_21
    targetCompatibility = JavaVersion.VERSION_21
}
</code></pre>
</section><section>
<div class="mermaid">
timeline
  Startup: bin/java GradleWrapperMain
         : start/connect Daemon
  Configuration: collect scripts
               : select ScriptPlugin
               : compile Program
  Execution: Create delegate PluginDependenciesSpec, Project, Settings, Gradle
           : Evaluate Script
           : Call Program.execute
</div>
</section><section>
<h3 id="partial-evaluation">Partial Evaluation</h3>
<p><span class='fragment ' >Interpreter for the Kotlin DSL based on the idea of partial evaluation.</span></p>
<p><span class='fragment ' >Instead of interpreting a given Kotlin DSL script directly, the interpreter emits a specialized program.</span></p>
<p><span class='fragment ' >Because each program is specialized for a given script structure, a lot of work is avoided.</span></p>
</section><section>
<p>/$GRADLE_HOME/caches/$GRADLE_VERSION/kotlin-dsl/scripts/$CACHE_KEY/instrumented/classes</p>
<ul>
<li>Build_gradle.class</li>
<li>Program.class</li>
</ul>
</section><section>
<h3 id="program-for-loading-plugins">Program for Loading Plugins</h3>
<pre><code class="language-kotlin" data-line-numbers>class Build_gradle(
  host: KotlinScriptHost&lt;ExtensionAware&gt;,
  pluginDependencies: PluginDependenciesSpec
) : CompiledKotlinPluginsBlock {
  constructor() {
    pluginDependencies.id(&quot;org.jetbrains.kotlin.jvm&quot;)
  }
}
</code></pre>
</section><section>
<h3 id="program-for-running-buildgradlekts">Program for Running build.gradle.kts</h3>
<pre><code class="language-kotlin" data-line-numbers>class Build_gradle(
  host: KotlinScriptHost&lt;Project&gt;
) : CompiledKotlinBuildScript by host.project {
  constructor() {
    getExtensions().configure(JavaPluginExtension::class.java) {
      sourceCompatibility = JavaVersion.VERSION_21
      targetCompatibility = JavaVersion.VERSION_21
    }
  }
}
</code></pre>
</section><section>
<h3 id="where-does-plugindependenciesspec-come-from">Where Does PluginDependenciesSpec Come From?</h3>
</section>
<section data-noprocess data-shortcode-slide
      data-transition="none"
      data-transition-speed="fast">
<p>Our Compiled Script for Plugin Resolution</p>
<pre><code class="language-java" data-line-numbers>public final class Program extends ExecutableProgram {
  public void execute(
    ExecutableProgram.Host executableProgramHost, 
    KotlinScriptHost&lt;?&gt; kotlinScriptHost
  ) {
    // ...
  }
}
</code></pre>
</section>
<section data-noprocess data-shortcode-slide
      data-transition="none"
      data-transition-speed="fast">
<pre><code class="language-java" data-line-numbers="9-18">public final class Program extends ExecutableProgram {
  public void execute(
    ExecutableProgram.Host executableProgramHost, 
    KotlinScriptHost&lt;?&gt; kotlinScriptHost
  ) {
    executableProgramHost.setupEmbeddedKotlinFor(kotlinScriptHost);

    try {
      // The real delegate of the plugins {} block.
      PluginRequestCollector pluginRequestCollector = 
              new PluginRequestCollector(kotlinScriptHost.getScriptSource());
      
      new Build_gradle(kotlinScriptHost, pluginRequestCollector.createSpec(2));
      
      executableProgramHost.applyPluginsTo(
              kotlinScriptHost, 
              pluginRequestCollector.getPluginRequests()
      );
    } catch (Throwable t) {
      executableProgramHost.handleScriptException(t, Build_gradle.class, kotlinScriptHost);
    }

    executableProgramHost.applyBasePluginsTo((Project)kotlinScriptHost.getTarget());
  }
}
</code></pre>
</section>
<section data-noprocess data-shortcode-slide
      data-transition="none"
      data-transition-speed="fast">
<pre><code class="language-java" data-line-numbers="4-6">class PluginRequestCollector {
  private final List&lt;PluginDependencySpecImpl&gt; specs = new LinkedList&lt;PluginDependencySpecImpl&gt;();
    
  public PluginDependenciesSpec createSpec(final int pluginsBlockLineNumber) {
    return new PluginDependenciesSpecImpl(pluginsBlockLineNumber);
  }

  private class PluginDependenciesSpecImpl implements PluginDependenciesSpec {
    private final int blockLineNumber;

    public PluginDependenciesSpecImpl(int blockLineNumber) {
      this.blockLineNumber = blockLineNumber;
    }

    @Override
    public PluginDependencySpec id(String id) {
      return id(id, blockLineNumber);
    }

    public PluginDependencySpec id(String id, int requestLineNumber) {
      PluginDependencySpecImpl spec = new PluginDependencySpecImpl(id, requestLineNumber);
      specs.add(spec);
      return spec;
    }
  }
}
</code></pre>
</section><section>
<pre><code class="language-java" data-line-numbers="2,8">class PluginRequestCollector {
  private final List&lt;PluginDependencySpecImpl&gt; specs = new LinkedList&lt;PluginDependencySpecImpl&gt;();
    
  public PluginDependenciesSpec createSpec(final int pluginsBlockLineNumber) {
    return new PluginDependenciesSpecImpl(pluginsBlockLineNumber);
  }

  private class PluginDependenciesSpecImpl implements PluginDependenciesSpec {
    private final int blockLineNumber;

    public PluginDependenciesSpecImpl(int blockLineNumber) {
      this.blockLineNumber = blockLineNumber;
    }

    @Override
    public PluginDependencySpec id(String id) {
      return id(id, blockLineNumber);
    }

    public PluginDependencySpec id(String id, int requestLineNumber) {
      PluginDependencySpecImpl spec = new PluginDependencySpecImpl(id, requestLineNumber);
      specs.add(spec);
      return spec;
    }
  }
}
</code></pre>
</section>
<section data-noprocess data-shortcode-slide
      data-transition="none"
      data-transition-speed="fast">
<pre><code class="language-kotlin">class Build_gradle(
    host: org.gradle.kotlin.dsl.support.KotlinScriptHost&lt;*&gt;,
    pluginDependencies: org.gradle.plugin.use.PluginDependenciesSpec
) : org.gradle.kotlin.dsl.support.CompiledKotlinPluginsBlock {
    fun plugins(configure: PluginDependenciesSpec.() -&gt; Unit) {
        configure(pluginDependencies) // simplified!!!
    }
}

val build_gradle = Build_gradle(kotlinScriptHost, pluginRequestCollector.createSpec(2))
build_gradle.plugins { 
    id(&quot;org.jetbrains.kotlin.jvm&quot;)
}
</code></pre>
</section><section>
<h3 id="what-would-happen">What Would Happen?</h3>
<pre><code class="language-kotlin" data-line-numbers>plugins {
    id(&quot;org.jetbrains.kotlin.jvm&quot;)
}

java {
    plugins {
        id(&quot;com.android.application&quot;)
    }
}
</code></pre>
</section><section>
<p>Calling <code>plugins {}</code> dynamically inside the script body would not work because
the plugins must be applied at an earlier stage in the build lifecycle.</p>
<pre><code class="language-kotlin">abstract class KotlinBuildScript(
    private val host: KotlinScriptHost&lt;Project&gt;
) : ProjectDelegate() {
    @Suppress(&quot;unused&quot;)
    fun plugins(@Suppress(&quot;unused_parameter&quot;) block: PluginDependenciesSpecScope.() -&gt; Unit): Unit =
        invalidPluginsCall()
}
</code></pre>
</section><section>
<pre><code>* Exception is:
java.lang.Exception: The plugins {} block must not be used here.
   If you need to apply a plugin imperatively, 
   please use apply&lt;PluginType&gt;() or apply(plugin = &quot;id&quot;) instead.
	
	at org.gradle.kotlin.dsl.support.CompiledKotlinBuildScriptKt.invalidPluginsCall(CompiledKotlinBuildScript.kt:143)
	at org.gradle.kotlin.dsl.support.CompiledKotlinBuildScript.plugins(CompiledKotlinBuildScript.kt:61)
	at Build_gradle$2$3.invoke(build.gradle.kts:71)

</code></pre>
</section><section>
<h3 id="what-weve-learned">What We&rsquo;ve Learned?</h3>
<p>What you see in build.gradle.kts gets compiled in two passes.</p>
<blockquote>
<p>A top-level script containing a plugins block but no body will be compiled down to a specialized program that instantiates the compiled plugins block class directly - without reflection - and does nothing else.</p></blockquote>

</section>
</section><section>


<section data-shortcode-section>
<h4 id="constructor-driven-execution">Constructor-Driven Execution</h4>
<pre><code class="language-java">/**
 * class Build_gradle(host: KotlinScriptHost&lt;Project&gt;, $$implicitReceiver0: Project) : CompiledKotlinBuildScript
 */
public final class Build_gradle extends CompiledKotlinBuildScript {
    public Build_gradle(KotlinScriptHost host) {
        // ...
        Accessors96b3ii45gitqpy1kb3tvcvtxvKt.java(
                (Project)this,
                Build_gradle::_init_$lambda$0
        );
    }

    private static final void _init_$lambda$0(JavaPluginExtension extension) {
        extension.setSourceCompatibility(JavaVersion.VERSION_21);
        extension.setTargetCompatibility(JavaVersion.VERSION_21);
    }
}
</code></pre>
</section><section>
<h4 id="everything-is-still-gradle-public-api">Everything Is Still Gradle Public API</h4>
<pre><code class="language-java">public final class Build_gradle extends CompiledKotlinBuildScript {
    public Build_gradle(KotlinScriptHost host) {
        ExtensionAware extensionAware = (ExtensionAware) this;
        extensionAware.getExtensions().configure(
                JavaPluginExtension.class,
                new Action&lt;JavaPluginExtension&gt;() {
            @Override
            public void execute(JavaPluginExtension extension) {
                extension.setSourceCompatibility(JavaVersion.VERSION_21);
                extension.setTargetCompatibility(JavaVersion.VERSION_21);
            }
        });
    }
}
</code></pre>
</section><section>
<h4 id="kotlin-equivalent">Kotlin Equivalent</h4>
<pre><code class="language-kotlin">plugins {
    id(&quot;org.jetbrains.kotlin.jvm&quot;)
}

// !!! 'this' won't typecast to ExtensionAware
val extensionAware: ExtensionAware = project 
extensionAware.extensions.configure(&quot;java&quot;, Action&lt;JavaPluginExtension&gt;{
    val extension: JavaPluginExtension = this
    extension.sourceCompatibility = JavaVersion.VERSION_21
    extension.targetCompatibility = JavaVersion.VERSION_21
})
</code></pre>
</section><section>
<h4 id="or-simply-use-kotlin-dsl"><a href="https://github.com/runningcode/kotlin-dsl/blob/master/subprojects/provider/src/main/kotlin/org/gradle/kotlin/dsl/ExtensionAwareExtensions.kt#L41-L49" target="_blank" rel="noopener">Or Simply Use Kotlin DSL</a></h4>
<pre><code class="language-kotlin">plugins {
    id(&quot;org.jetbrains.kotlin.jvm&quot;)
}

configure&lt;JavaPluginExtension&gt; {
    sourceCompatibility = JavaVersion.VERSION_21
    targetCompatibility = JavaVersion.VERSION_21
}
</code></pre>
</section><section>
<h3 id="what-weve-learned">What We&rsquo;ve Learned?</h3>
<p>Gradle uses the Kotlin compiler’s scripting engine.
The generated class Build_gradle is the concrete implementation of your build script.</p>
<pre><code class="language-kotlin">abstract class KotlinBuildScript(
    private val host: KotlinScriptHost&lt;Project&gt;
) : Project by host.target {}
</code></pre>

</section>
</section><section>


<section data-shortcode-section>
<h3 id="gradle-groovy-script-model">Gradle Groovy Script Model</h3>
</section><section>
<pre><code class="language-groovy">// Simulate Gradle's behavior:
// 1. Create a Project instance.
def projectInstance = new Project(&quot;MyAwesomeProject&quot;)
// 2. Inject the Project into the Binding.
def binding = new Binding([project: projectInstance])
// 3. Create the build script with the binding.
def scriptInstance = new build_cfj79vrwubnnl9mpc4lxadrlm(binding)
// 4. Run the script.
scriptInstance.run()
</code></pre>
</section><section>
<h3 id="script-example">Script Example</h3>
<pre><code class="language-groovy">Project currentProject = getProject()
def build_gradle = this
</code></pre>
</section><section>
<h3 id="script-compiled-to">Script Compiled To</h3>
<pre><code class="language-java">import org.codehaus.groovy.runtime.ScriptBytecodeAdapter;
import org.codehaus.groovy.runtime.callsite.CallSite;

public class build_cfj79vrwubnnl9mpc4lxadrlm 
        extends ProjectScript implements ScriptOrigin {
    public Object run() {
        CallSite[] var1 = $getCallSiteArray();
        Project currentProject = (Project)ScriptBytecodeAdapter.castToType(
                var1[0].callCurrent(this), 
                Project.class
        );
        Object build_gradle = this;
    }
}
</code></pre>
</section><section>
<h3 id="what-weve-learned">What We&rsquo;ve Learned?</h3>
<p>Method calls are transformed into <strong>CallSite</strong> objects.
These objects are responsible for resolving and invoking the methods at runtime.
The calls will be delegated to the Project instance.</p>

</section>
</section><section>
<h3 id="gradle-api-surface">Gradle API Surface</h3>
<div class="mermaid">
graph TD;
    Project-->ExtensionContainer;
    Project-->NamedDomainObjectSet;
    ExtensionContainer-->Extension;
    Extension-->Provider;
    Extension-->Property;
    Extension-->NamedDomainObjectSet;

</div>


</section><section>


<section data-shortcode-section>
<h3 id="gradle-api-extension">Gradle API: Extension</h3>
<p>Is a contract between the plugin and the consumer. It acts as a type-safe API for the plugin
consumer to provide essential details.</p>
<pre><code class="language-kotlin">android {
    namespace = &quot;com.example.myproject&quot;
    compileSdk = 35
}
</code></pre>
</section><section>
<h3 id="extensioncontainer">ExtensionContainer</h3>
<pre><code class="language-kotlin">// top-level extensions
val projectExtensionContainer: ExtensionContainer = project.extensions
project.tasks.withType&lt;Test&gt;().configureEach { 
    val self: Test = this
    // We can access it within any instance of Test task
    val testExtensionContainer: ExtensionContainer = self.extensions
}
</code></pre>
</section><section>
<h3 id="enable-verbose-logging-in-tests">Enable Verbose Logging in Tests</h3>
<pre><code class="language-shell">./gradlew :mymodule:test -PverboseTest=true
</code></pre>
<p><span class='fragment ' >Define extension type that reads -PverboseTest prop.</span></p>
<p><span class='fragment ' >Create extension for every Test task.</span></p>
<p><span class='fragment ' >Within every Test task, access the extension.</span></p>
</section><section>
<pre><code class="language-kotlin" data-line-numbers>abstract class VerboseTesting @Inject constructor(
    private val providers: ProviderFactory
) {
    fun enableVerbose(): Boolean {
        return providers.gradleProperty(&quot;verboseTest&quot;)
            .map { it.isNotEmpty() }
            .getOrElse(false)
    }
}

</code></pre>
</section><section>
<pre><code class="language-kotlin" data-line-numbers>project.tasks.withType&lt;Test&gt;().configureEach {
    val self: Test = this
    self.extensions.create(
        &quot;verboseTest&quot;,
        VerboseTesting::class.java,
    )
}
</code></pre>
</section><section>
<pre><code class="language-kotlin" data-line-numbers>project.tasks.withType&lt;Test&gt;().configureEach {
    val self: Test = this
    val verboseTesting = self.extensions.getByType&lt;VerboseTesting&gt;()
    // val verboseTesting = self.extensions.getByType(VerboseTesting::class.java)
    self.logger.lifecycle(&quot;Verbose testing is enabled: ${verboseTesting.enableVerbose()}&quot;)
    if (verboseTesting.enableVerbose()) {
        self.testLogging {
            testLogging {
                exceptionFormat = TestExceptionFormat.FULL
            }
        }
    }
}
</code></pre>

</section>
</section><section>


<section data-shortcode-section>
<h3 id="gradle-api-ndoc">Gradle API: NDOC</h3>
</section><section>
<p>“A named domain object container is a specialization of NamedDomainObjectSet that adds the ability to create instances of the element type.” (Gradle Docs)</p>
</section><section>
<figure><img src="/notes-vault/gradle-delegator/images/thinker.jpg" width="750" height="731">
</figure>
</section><section>
<pre><code class="language-kotlin" data-line-numbers="3-5">android {
  buildTypes {
        release {
            isMinifyEnabled = true
        }
    }
}
</code></pre>
</section><section>
<pre><code class="language-kotlin" data-line-numbers>val myAndroid = project.the&lt;AppExtension&gt;()

// NamedDomainObjectContainer&lt;BuildType&gt;
val buildTypes = myAndroid.buildTypes

val release: BuildType by buildTypes.getting
val releaseTheSame: BuildType = buildTypes.getByName(&quot;release&quot;)

val releaseProvider: NamedDomainObjectProvider&lt;BuildType&gt; =
   buildTypes.named(&quot;release&quot;) {
     check(release == releaseTheSame)
     check(release == this)
     check(releaseTheSame == this)
   }
</code></pre>
</section><section>
<h3 id="agp-and-ndoc">AGP and NDOC</h3>
<p>The most known applications of NDOC are exposed types under the <code>android</code> extension.</p>
</section><section>
<ul>
<li>ProductFlavor</li>
</ul>
<pre><code class="language-kotlin">android {
    productFlavors {
        free { dimension = &quot;pricing&quot; }
    }
}
</code></pre>
</section><section>
<ul>
<li>SourceSet</li>
</ul>
<pre><code class="language-kotlin">sourceSets {
    main {
        res {
            srcDir(&quot;src/androidTest/res&quot;)
        }
    }
}
</code></pre>
</section><section>
<ul>
<li>Configuration (e.g., implementation())</li>
</ul>
<pre><code class="language-kotlin">dependencies {
    implementation(&quot;javax.inject:javax.inject:1&quot;)
}
</code></pre>

</section>
</section><section>
<h3 id="gradle-delegates">Gradle Delegates</h3>
<figure><img src="/notes-vault/gradle-delegator/images/delegate-types.png" width="630" height="280">
</figure>

</section><section>
<h3 id="qa">QA</h3>
<div class="qr-columns">
    <div class="qr-item">
        <div id="me" class="qr"></div>
        <h4>Get in Touch</h4>
    </div>
    <div class="qr-item">
        <div id="thisPresentation" class="qr"></div>
        <h4>This presentation</h4>
    </div>
</div>
<script>
    new QRCode(document.getElementById("me"), {
        text: "https://bento.me/tomkoptel",
        width: 200,
        height: 200,
    });
    new QRCode(document.getElementById("thisPresentation"), {
        text: "https://tomkoptel.github.io/notes-vault/gradle-delegator/",
        width: 200,
        height: 200,
    });
</script>
</section>

  


</div>
      

    </div>
<script type="text/javascript" src=/notes-vault/reveal-hugo/object-assign.js></script>


<script src="/notes-vault/reveal-js/dist/reveal.js"></script>


  <script type="text/javascript" src="/notes-vault/reveal-js/plugin/markdown/markdown.js"></script>
  
  <script type="text/javascript" src="/notes-vault/reveal-js/plugin/highlight/highlight.js"></script>
  
  <script type="text/javascript" src="/notes-vault/reveal-js/plugin/zoom/zoom.js"></script>
  
  <script type="text/javascript" src="/notes-vault/reveal-js/plugin/notes/notes.js"></script>
  
<script type="text/javascript">
  
  
  function camelize(map) {
    if (map) {
      Object.keys(map).forEach(function(k) {
        newK = k.replace(/(\_\w)/g, function(m) { return m[1].toUpperCase() });
        if (newK != k) {
          map[newK] = map[k];
          delete map[k];
        }
      });
    }
    return map;
  }

  var revealHugoDefaults = { center: true, controls: true, history: true, progress: true, transition: "slide" };
  var revealHugoSiteParams = {};
  var revealHugoPageParams = {"highlight_theme":"idea","slide_number":true,"theme":"simple","transition":"slide"};

  var revealHugoPlugins = {
    
    plugins: [RevealMarkdown,RevealHighlight,RevealZoom,RevealNotes]
  };

  
  var options = Object.assign({},
    camelize(revealHugoDefaults),
    camelize(revealHugoSiteParams),
    camelize(revealHugoPageParams),
    camelize(revealHugoPlugins));

  Reveal.initialize(options);
</script>





  
  

  
    
  
  

  
  

  
  

  
  



  
  <script type="text/javascript" src="/notes-vault/mermaid.min_16862243754454536095.js"></script>
  <script type="text/javascript">
    mermaid.initialize({startOnLoad: false});
    let render = (event) => {
      let mermaidElems = event.currentSlide.querySelectorAll('.mermaid');
      if (!mermaidElems.length){
          return
      }
      mermaidElems.forEach(mermaidElem => {
          let processed = mermaidElem.getAttribute('data-processed');
          if (!processed){
              
              mermaid.init(undefined, mermaidElem);
          }
      });
    };
    
    render({currentSlide: Reveal.getCurrentSlide()});

    Reveal.on('slidechanged', render);
    Reveal.on('ready', render);
  </script>



    
    
  </body>
</html>

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<title>Gradle, the Ultimate Delegator</title>


<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><link rel="stylesheet" href="/notes-vault/reveal-js/dist/reset.css">
<link rel="stylesheet" href="/notes-vault/reveal-js/dist/reveal.css"><link rel="stylesheet" href="/notes-vault/reveal-js/dist/theme/simple.css" id="theme">
<link rel="stylesheet" href="/notes-vault/highlight-js/idea.min.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
    .qr {
      padding: 20px;
      background-color: white;
      border: 2px solid #ccc;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .qr img {
        display: block;
        margin: 0 auto;
    }

    .qr-columns {
        display: flex;  
        justify-content: space-between;  
        gap: 20px;  
    }

    .qr-item {
        flex: 1;  
        text-align: center;  
    }

    .qr-item h3 {
        margin-bottom: 10px;  
    }

    .qr-item div {
        margin: 0 auto;  
        width: 200px;  
        height: 200px;  
    }
</style>

<style>
    .reveal pre {
        font-size: 0.45em;
    }
</style>
  </head>
  <body>
    
    <div class="reveal">
      <div class="slides">
  

    <section><h3 id="gradle-the-ultimate-delegator">Gradle, the Ultimate Delegator</h3>
<figure><img src="/notes-vault/gradle-delegator/images/alligator.jpeg" width="400" height="216"><figcaption>
      <h4>Graphle</h4>
    </figcaption>
</figure>

</section><section>


<section data-shortcode-section>
<h3 id="gradle-is-a-delegator">Gradle is a Delegator</h3>
<figure><img src="/notes-vault/gradle-delegator/images/delegate-types.png" width="630" height="280">
</figure>
</section><section>
<h3 id="access-project-instance">Access Project instance</h3>
<p>You can access project in any module (e.g. app/build.gradle) also in the root project <strong>build.gradle</strong> file.
The statement is true for Groovy and Kotlin based scripts.</p>
<pre><code class="language-kotlin">/**
 * Returns this project. This method is useful in build files to
 * explicitly access project properties and methods.
 */
val thisProject: Project = project
</code></pre>

</section>
</section><section>


<section data-shortcode-section>
<h3 id="gradle-kts-script-model">Gradle KTS Script Model</h3>
</section><section>
<pre><code class="language-kotlin">plugins {
    id(&quot;org.jetbrains.kotlin.jvm&quot;)
}

java {
    sourceCompatibility = JavaVersion.VERSION_21
    targetCompatibility = JavaVersion.VERSION_21
}
</code></pre>
</section><section>
<h4 id="everything-starts-with-main">Everything starts with main</h4>
<pre><code class="language-java">public final class Build_gradle extends KotlinBuildScript {
    public static final void main(String[] args) {
        RunnerKt.runCompiledScript(Build_gradle.class, args);
    }
}
</code></pre>
</section><section>
<h4 id="runner">Runner</h4>
<pre><code class="language-kotlin">val evaluator = BasicJvmScriptEvaluator()
val evaluationConfiguration: ScriptEvaluationConfiguration = //...
runBlocking {
    evaluator(script, evaluationConfiguration).onFailure {
        it.reports.forEach(System.err::println)
    }
}    

</code></pre>
</section><section>
<h4 id="constructor-driven-execution">Constructor driven execution</h4>
<pre><code class="language-java">public final class Build_gradle extends KotlinBuildScript {
    public Build_gradle(KotlinScriptHost host) {
        // ...
        Accessors96b3ii45gitqpy1kb3tvcvtxvKt.java(
                (Project)this,
                Build_gradle::_init_$lambda$0
        );
    }

    private static final void _init_$lambda$0(JavaPluginExtension extension) {
        extension.setSourceCompatibility(JavaVersion.VERSION_21);
        extension.setTargetCompatibility(JavaVersion.VERSION_21);
    }
}
</code></pre>
</section><section>
<h4 id="everything-is-still-gradle-public-api">Everything is still Gradle Public API</h4>
<pre><code class="language-java">public final class Build_gradle extends KotlinBuildScript {
    public Build_gradle(KotlinScriptHost host) {
        ExtensionAware extensionAware = (ExtensionAware) this;
        project.getExtensions().configure(
                JavaPluginExtension.class,
                new Action&lt;JavaPluginExtension&gt;() {
            @Override
            public void execute(JavaPluginExtension extension) {
                extension.setSourceCompatibility(JavaVersion.VERSION_21);
                extension.setTargetCompatibility(JavaVersion.VERSION_21);
            }
        });
    }
}
</code></pre>
</section><section>
<h4 id="kotlin-equivalent">Kotlin equivalent</h4>
<pre><code class="language-kotlin">plugins {
    id(&quot;org.jetbrains.kotlin.jvm&quot;)
}

// !!! 'this' won't typecast to ExtensionAware
val extensionAware: ExtensionAware = project 
extensionAware.extensions.configure(&quot;java&quot;, Action&lt;JavaPluginExtension&gt;{
    val extension: JavaPluginExtension = this
    extension.sourceCompatibility = JavaVersion.VERSION_21
    extension.targetCompatibility = JavaVersion.VERSION_21
})
</code></pre>
</section><section>
<h4 id="or-simply-use-kotlin-dsl"><a href="https://github.com/runningcode/kotlin-dsl/blob/master/subprojects/provider/src/main/kotlin/org/gradle/kotlin/dsl/ExtensionAwareExtensions.kt#L41-L49" target="_blank" rel="noopener">Or simply use Kotlin DSL</a></h4>
<pre><code class="language-kotlin">plugins {
    id(&quot;org.jetbrains.kotlin.jvm&quot;)
}

configure&lt;JavaPluginExtension&gt; {
    sourceCompatibility = JavaVersion.VERSION_21
    targetCompatibility = JavaVersion.VERSION_21
}
</code></pre>
</section><section>
<h3 id="what-weve-learned">What we&rsquo;ve learned?</h3>
<p>Gradle uses the Kotlin compiler’s scripting engine.
The generated class Build_gradle is the concrete implementation of your build script.</p>
<pre><code class="language-kotlin">abstract class KotlinBuildScript(
    private val host: KotlinScriptHost&lt;Project&gt;
) : Project by host.target {}
</code></pre>

</section>
</section><section>


<section data-shortcode-section>
<h3 id="gradle-groovy-script-model">Gradle Groovy Script Model</h3>
</section><section>
<pre><code class="language-groovy">// Simulate Gradle's behavior:
// 1. Create a Project instance.
def projectInstance = new Project(&quot;MyAwesomeProject&quot;)
// 2. Inject the Project into the Binding.
def binding = new Binding([project: projectInstance])
// 3. Create the build script with the binding.
def scriptInstance = new build_cfj79vrwubnnl9mpc4lxadrlm(binding)
// 4. Run the script.
scriptInstance.run()
</code></pre>
</section><section>
<h3 id="script-example">Script Example</h3>
<pre><code class="language-groovy">Project currentProject = getProject()
def build_gradle = this
</code></pre>
</section><section>
<h3 id="script-compiled-to">Script Compiled To</h3>
<pre><code class="language-java">import org.codehaus.groovy.runtime.ScriptBytecodeAdapter;
import org.codehaus.groovy.runtime.callsite.CallSite;

public class build_cfj79vrwubnnl9mpc4lxadrlm 
        extends ProjectScript implements ScriptOrigin {
    public Object run() {
        CallSite[] var1 = $getCallSiteArray();
        Project currentProject = (Project)ScriptBytecodeAdapter.castToType(
                var1[0].callCurrent(this), 
                Project.class
        );
        Object build_gradle = this;
    }
}
</code></pre>
</section><section>
<h3 id="what-weve-learned">What we&rsquo;ve learned?</h3>
<p>Method calls are transformed into <strong>CallSite</strong> objects.
These objects are responsible for resolving and invoking the methods at runtime.
The calls will be delegated to the Project instance.</p>

</section>
</section><section>


<section data-shortcode-section>
<h3 id="how-gradle-enriches-its-classpath">How Gradle enriches its classpath?</h3>
</section><section>
<pre><code class="language-kotlin">plugins {
    id(&quot;org.jetbrains.kotlin.jvm&quot;)
}
</code></pre>
</section><section>
<p>The <code>plugins</code> block not included into Build_gradle script.</p>
<pre><code class="language-kotlin">abstract class KotlinBuildScript(
    private val host: KotlinScriptHost&lt;Project&gt;
) : ProjectDelegate() {
    @Suppress(&quot;unused&quot;)
    fun plugins(@Suppress(&quot;unused_parameter&quot;) block: PluginDependenciesSpecScope.() -&gt; Unit): Unit =
        invalidPluginsCall()
}
</code></pre>
</section><section>
<div class="mermaid">
sequenceDiagram
    participant GW as Gradle Wrapper
    participant GD as Gradle Daemon
    participant PI as Project Initialization
    participant FS as File System
    participant SS as ScriptSource
    participant SR as ScriptRunner
    participant PAS as PluginsAwareScript
    participant PRC as PluginRequestCollector
    participant CU as ConfigureUtil
    participant PRS as PluginResolution System
    %% Start: Gradle startup and project creation
    GW->>GD: Invoke Gradle build (e.g. ./gradlew :app:tasks)
    GD->>PI: Initialize project 'app'
    PI->>FS: Locate build.gradle file
    FS-->>PI: Return build.gradle content
    %% ScriptSource creation and script runner instantiation
    PI->>SS: Wrap build.gradle content into a ScriptSource
    PI->>SR: Create ScriptRunner with ScriptSource & context ClassLoader
    SR->>PAS: Instantiate build script (a PluginsAwareScript subclass)
    %% Parsing of the plugins block in the build script
    PAS->>PAS: Encounter call to plugins(lineNumber, closure)
    Note over PAS: plugins block defined in build.gradle\n(e.g., plugins { ... })
    PAS->>PRC: Check if PluginRequestCollector exists\nIf not, create one using ScriptSource
    PRC-->>PAS: Return PluginRequestCollector instance
    PAS->>PRC: Call createSpec(lineNumber) to create PluginDependenciesSpec
    PRC-->>PAS: Return PluginDependenciesSpec object
    PAS->>CU: Invoke ConfigureUtil.configure(configureClosure, spec)
    CU-->>PAS: Apply closure configuring the PluginDependenciesSpec
    %% Plugin request collection and resolution
    PAS->>PAS: Plugin requests recorded in PluginRequestCollector
    PAS->>PRS: Expose plugin requests via getPluginRequests()
    PRS->>PRS: Resolve plugins and add to classpath
</div>

</section>
</section><section>


<section data-shortcode-section>
<h3 id="gradle-api-extensions">Gradle API: Extensions</h3>
</section><section>
<pre><code class="language-kotlin">// The same as
// project.extensions.findByType(typeOf&lt;AppExtension&gt;()) 
val myAndroid = project.the&lt;AppExtension&gt;()
</code></pre>

</section>
</section><section>


<section data-shortcode-section>
<h3 id="gradle-api-ndoc">Gradle API: NDOC</h3>
</section><section>
<p>“A named domain object container is a specialization of NamedDomainObjectSet that adds the ability to create instances of the element type.” (Gradle Docs)</p>
</section><section>
<figure><img src="/notes-vault/gradle-delegator/images/thinker.jpg" width="750" height="731">
</figure>
</section><section>
<pre><code class="language-kotlin" data-line-numbers="3-5">android {
  buildTypes {
        release {
            isMinifyEnabled = true
        }
    }
}
</code></pre>
</section><section>
<pre><code class="language-kotlin" data-line-numbers>val myAndroid = project.the&lt;AppExtension&gt;()

// NamedDomainObjectContainer&lt;BuildType&gt;
val buildTypes = myAndroid.buildTypes

val release: BuildType by buildTypes.getting
val releaseTheSame: BuildType = buildTypes.getByName(&quot;release&quot;)
val releaseProvider: NamedDomainObjectProvider&lt;BuildType&gt; = 
  buildTypes.named(&quot;release&quot;) {
    check(release == releaseTheSame)
    check(release == this)
    check(releaseTheSame == this)
  }
</code></pre>
</section><section>
<h3 id="agp-and-ndoc">AGP and NDOC</h3>
<p>The most known application of NDOC are exposed types under <code>android</code> extension.</p>
<ul>
<li>productFlavors</li>
<li>sourceSets</li>
<li>buildTypes</li>
</ul>

</section>
</section>

  


</div>
      

    </div>
<script type="text/javascript" src=/notes-vault/reveal-hugo/object-assign.js></script>


<script src="/notes-vault/reveal-js/dist/reveal.js"></script>


  <script type="text/javascript" src="/notes-vault/reveal-js/plugin/markdown/markdown.js"></script>
  
  <script type="text/javascript" src="/notes-vault/reveal-js/plugin/highlight/highlight.js"></script>
  
  <script type="text/javascript" src="/notes-vault/reveal-js/plugin/zoom/zoom.js"></script>
  
  <script type="text/javascript" src="/notes-vault/reveal-js/plugin/notes/notes.js"></script>
  
<script type="text/javascript">
  
  
  function camelize(map) {
    if (map) {
      Object.keys(map).forEach(function(k) {
        newK = k.replace(/(\_\w)/g, function(m) { return m[1].toUpperCase() });
        if (newK != k) {
          map[newK] = map[k];
          delete map[k];
        }
      });
    }
    return map;
  }

  var revealHugoDefaults = { center: true, controls: true, history: true, progress: true, transition: "slide" };
  var revealHugoSiteParams = {};
  var revealHugoPageParams = {"highlight_theme":"idea","slide_number":true,"theme":"simple","transition":"slide"};

  var revealHugoPlugins = {
    
    plugins: [RevealMarkdown,RevealHighlight,RevealZoom,RevealNotes]
  };

  
  var options = Object.assign({},
    camelize(revealHugoDefaults),
    camelize(revealHugoSiteParams),
    camelize(revealHugoPageParams),
    camelize(revealHugoPlugins));

  Reveal.initialize(options);
</script>





  
  

  
    
  
  

  
  

  
  

  
  



  
  <script type="text/javascript" src="/notes-vault/mermaid.min_16862243754454536095.js"></script>
  <script type="text/javascript">
    mermaid.initialize({startOnLoad: false});
    let render = (event) => {
      let mermaidElems = event.currentSlide.querySelectorAll('.mermaid');
      if (!mermaidElems.length){
          return
      }
      mermaidElems.forEach(mermaidElem => {
          let processed = mermaidElem.getAttribute('data-processed');
          if (!processed){
              
              mermaid.init(undefined, mermaidElem);
          }
      });
    };
    
    render({currentSlide: Reveal.getCurrentSlide()});

    Reveal.on('slidechanged', render);
    Reveal.on('ready', render);
  </script>



    
    
  </body>
</html>
